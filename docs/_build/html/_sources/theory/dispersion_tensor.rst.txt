Dispersion Tensor
=================

The mechanical dispersion tensor in a porous medium is:

.. math::

   D_{ij} = \left(\alpha_T\, |\mathbf{v}| + D_m\right) \delta_{ij}
            + \left(\alpha_L - \alpha_T\right) \frac{v_i\, v_j}{|\mathbf{v}|}

where:

* :math:`\alpha_L` — longitudinal dispersivity [L]
* :math:`\alpha_T` — transverse dispersivity [L]
* :math:`D_m` — effective molecular diffusion coefficient [L²/T]
* :math:`|\mathbf{v}|` — magnitude of the velocity vector

Eigenvalues
-----------

The dispersion tensor has eigenvalues:

.. math::

   \lambda_L &= \alpha_L\,|\mathbf{v}| + D_m
     \qquad \text{(longitudinal, along } \mathbf{v}\text{)} \\
   \lambda_T &= \alpha_T\,|\mathbf{v}| + D_m
     \qquad \text{(transverse, 2× degenerate)}


Square-Root Decomposition (:math:`\mathbf{B}`)
-----------------------------------------------

The particle displacement requires :math:`\mathbf{B}` such that
:math:`\mathbf{B}\mathbf{B}^T = 2\mathbf{D}\,\Delta t`.

Par2_Core constructs B via analytical eigendecomposition (not Cholesky).
Define three (unnormalised) orthogonal eigenvectors:

.. math::

   \mathbf{e}_0 &= (v_x,\; v_y,\; v_z)
     \quad \text{(along flow, eigenvalue } \lambda_L \text{)} \\
   \mathbf{e}_1 &= (-v_y,\; v_x,\; 0)
     \quad \text{(⊥ in XY plane, eigenvalue } \lambda_T \text{)} \\
   \mathbf{e}_2 &= (-v_z v_x,\; -v_z v_y,\; v_x^2 + v_y^2)
     \quad \text{(⊥ to both, eigenvalue } \lambda_T \text{)}

Define gamma coefficients:

.. math::

   \gamma_i = \frac{\sqrt{\lambda_i}}{|\mathbf{e}_i|^2}

Then:

.. math::

   B_{jk} = \sqrt{2\,\Delta t}
     \sum_{i=0}^{2} \gamma_i \; e_i[j] \; e_i[k]

The result is a **symmetric** 3×3 matrix stored as 6 unique components
(``B00, B11, B22, B01, B02, B12``).

Special-Case Dispatching
------------------------

+--------------------------+------------------------------------------+
| Condition                | Behaviour                                |
+==========================+==========================================+
| Dm = αL = αT = 0         | B = 0 (no diffusion)                     |
+--------------------------+------------------------------------------+
| αL = αT = 0, Dm > 0      | B = √(2·Dm·dt) · I (isotropic)           |
+--------------------------+------------------------------------------+
| otherwise                | Full eigendecomposition (legacy path)    |
+--------------------------+------------------------------------------+


Zero-Velocity Handling
----------------------

When :math:`|\mathbf{v}| \to 0`, the division in :math:`D_{ij}` and the
eigenvector norms can produce NaN.  Par2_Core uses two legacy mechanisms:

**Mechanism 1 — Displacement matrix** (legacy ``displacementMatrix``):

.. math::

   \text{toll} = 0.01 \cdot D_m / \alpha_L, \qquad
   v_x \leftarrow \max(v_x, \text{toll})

Only :math:`v_x` is clamped.  This ensures :math:`|\mathbf{v}| > 0`
and :math:`|\mathbf{e}_1|^2,\, |\mathbf{e}_2|^2 > 0`.

**Mechanism 2 — Drift correction** (legacy ``velocityCorrection``):

.. math::

   \text{if } v_x < \text{toll} \;\wedge\; v_y < \text{toll}
              \;\wedge\; v_z < \text{toll}:
   \quad v_x \leftarrow \text{toll}

Applied at each of the 8 cell corners independently.

**Legacy bug fix:**  When :math:`\alpha_L = 0`, legacy computes
``toll = 0.01 * Dm / 0 = NaN``.  Par2_Core returns ``toll = 1e-15``
instead, which correctly produces zero drift without NaN propagation.

**Extra guards** (``nan_prevention`` flag, not in legacy):

* Clamps :math:`|\mathbf{e}_1|^2` and :math:`|\mathbf{e}_2|^2` to
  :math:`\text{toll}^2` when they approach zero (e.g., flow purely in Z).
* In precomputed drift: sets :math:`D = D_m \mathbf{I}` directly when
  :math:`|\mathbf{v}| < \text{toll}`.
